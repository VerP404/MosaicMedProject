@echo off
setlocal enabledelayedexpansion

rem Определение директории скрипта
set SCRIPT_DIR=%~dp0

rem Переход в корневую директорию проекта
cd /d %SCRIPT_DIR%\..

echo ===================================================
echo Активация виртуального окружения
echo ===================================================
call .venv\Scripts\activate.bat

echo ===================================================
echo Обновление кода из репозитория
echo ===================================================
git pull

echo ===================================================
echo Установка зависимостей
echo ===================================================
pip install -r requirements\base.txt

echo ===================================================
echo Выполнение миграций
echo ===================================================
python manage.py migrate

echo ===================================================
echo Создание папок для файлов с данными
echo ===================================================
rem Исправленная команда для создания папок
python mosaic_conductor\etl\create_folders.py
rem Или альтернативный вариант, если это команда Django:
rem python manage.py create_folders

echo ===================================================
echo Импорт данных из JSON
echo ===================================================
python manage.py data_import

echo ===================================================
echo Остановка текущих процессов по портам
echo ===================================================

rem Завершение процесса на порту 8000
echo Проверка порта 8000...
for /f "tokens=5" %%a in ('netstat -ano ^| findstr ":8000" ^| findstr "LISTENING"') do (
    set PID=%%a
    if not "!PID!"=="" (
        echo Найден процесс с PID !PID! на порту 8000. Завершение...
        taskkill /f /pid !PID! 2>nul
        if !ERRORLEVEL! EQU 0 (
            echo Процесс на порту 8000 успешно завершен.
        ) else (
            echo Не удалось завершить процесс на порту 8000.
        )
    ) else (
        echo Процессы на порту 8000 не найдены.
    )
)

rem Завершение процесса на порту 5000
echo Проверка порта 5000...
for /f "tokens=5" %%a in ('netstat -ano ^| findstr ":5000" ^| findstr "LISTENING"') do (
    set PID=%%a
    if not "!PID!"=="" (
        echo Найден процесс с PID !PID! на порту 5000. Завершение...
        taskkill /f /pid !PID! 2>nul
        if !ERRORLEVEL! EQU 0 (
            echo Процесс на порту 5000 успешно завершен.
        ) else (
            echo Не удалось завершить процесс на порту 5000.
        )
    ) else (
        echo Процессы на порту 5000 не найдены.
    )
)

rem Завершение процесса на порту 5010
echo Проверка порта 5010...
for /f "tokens=5" %%a in ('netstat -ano ^| findstr ":5010" ^| findstr "LISTENING"') do (
    set PID=%%a
    if not "!PID!"=="" (
        echo Найден процесс с PID !PID! на порту 5010. Завершение...
        taskkill /f /pid !PID! 2>nul
        if !ERRORLEVEL! EQU 0 (
            echo Процесс на порту 5010 успешно завершен.
        ) else (
            echo Не удалось завершить процесс на порту 5010.
        )
    ) else (
        echo Процессы на порту 5010 не найдены.
    )
)

echo ===================================================
echo Перезапуск серверов в фоне
echo ===================================================
start "" python manage.py runserver 0.0.0.0:8000
start "" python apps\analytical_app\index.py
start "" python apps\chief_app\main.py

echo ===================================================
echo Деактивация виртуального окружения
echo ===================================================
deactivate.bat

echo ===================================================
echo Деплой успешно завершен!
echo ===================================================
pause