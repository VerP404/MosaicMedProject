{% extends 'home/base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'zones:organizations_list' %}">Система участков</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'zones:organization_detail' corpus.organization.pk %}">{{ corpus.organization.name }}</a></li>
                    <li class="breadcrumb-item active">{{ corpus.name }}</li>
                </ol>
            </nav>
            <h1 class="h3 mb-0">
                <i class="fas fa-building me-2"></i>
                {{ corpus.name }}
            </h1>
            <p class="text-muted">{{ corpus.organization.name }}</p>
        </div>
    </div>

    <div class="row">
        <!-- Информация о корпусе -->
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Информация
                    </h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-5">Организация:</dt>
                        <dd class="col-sm-7">
                            <a href="{% url 'zones:organization_detail' corpus.organization.pk %}">
                                {{ corpus.organization.name }}
                            </a>
                        </dd>
                        
                        <dt class="col-sm-5">Название:</dt>
                        <dd class="col-sm-7">{{ corpus.name }}</dd>
                        
                        {% if corpus.address %}
                        <dt class="col-sm-5">Адрес:</dt>
                        <dd class="col-sm-7">
                            {{ corpus.address.street }} {{ corpus.address.housenumber }}
                        </dd>
                        {% endif %}
                        
                        {% if corpus.description %}
                        <dt class="col-sm-5">Описание:</dt>
                        <dd class="col-sm-7">{{ corpus.description }}</dd>
                        {% endif %}
                        
                        <dt class="col-sm-5">Участков:</dt>
                        <dd class="col-sm-7">
                            <span class="badge bg-primary">{{ sites.count }}</span>
                        </dd>
                    </dl>
                </div>
                <div class="card-footer">
                    <a href="/admin/zones/corpus/{{ corpus.id }}/change/" 
                       class="btn btn-primary btn-sm w-100">
                        <i class="fas fa-edit me-1"></i>
                        Редактировать в админке
                    </a>
                </div>
            </div>

            <!-- Управление участками -->
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-plus-circle me-2"></i>
                        Создать участок
                    </h5>
                </div>
                <div class="card-body">
                    <form id="site-form">
                        <div class="mb-3">
                            <label class="form-label">Название участка:</label>
                            <input type="text" 
                                   id="site-name" 
                                   class="form-control" 
                                   required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Тип участка:</label>
                            <select id="site-type" class="form-select" required>
                                <option value="">Выберите тип...</option>
                                {% for site_type in site_types %}
                                <option value="{{ site_type.code }}">{{ site_type.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Цвет:</label>
                            <input type="color" 
                                   id="site-color" 
                                   class="form-control form-control-color" 
                                   value="#4ecdc4">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Описание:</label>
                            <textarea id="site-description" 
                                      class="form-control" 
                                      rows="2"></textarea>
                        </div>
                        <input type="hidden" id="site-id" value="">
                        <div class="d-grid gap-2">
                            <button type="submit" 
                                    id="btn-save-site" 
                                    class="btn btn-success">
                                <i class="fas fa-save me-1"></i>
                                Сохранить участок
                            </button>
                            <button type="button" 
                                    id="btn-cancel-edit" 
                                    class="btn btn-secondary" 
                                    style="display: none;">
                                <i class="fas fa-times me-1"></i>
                                Отменить редактирование
                            </button>
                        </div>
                    </form>
                    <div id="save-status" class="mt-3"></div>
                </div>
            </div>

            <!-- Фильтр по типам участков -->
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-filter me-2"></i>
                        Фильтр участков
                    </h5>
                </div>
                <div class="card-body">
                    <div class="form-check">
                        <input class="form-check-input" 
                               type="checkbox" 
                               id="filter-all" 
                               checked>
                        <label class="form-check-label" for="filter-all">
                            Все участки
                        </label>
                    </div>
                    {% for site_type in site_types %}
                    <div class="form-check">
                        <input class="form-check-input site-type-filter" 
                               type="checkbox" 
                               id="filter-{{ site_type.code }}" 
                               data-type="{{ site_type.code }}"
                               checked>
                        <label class="form-check-label" for="filter-{{ site_type.code }}">
                            {{ site_type.name }}
                        </label>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Фильтр адресов -->
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-warning text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-map-marker-alt me-2"></i>
                        Адреса
                    </h5>
                </div>
                <div class="card-body">
                    <div class="form-check">
                        <input class="form-check-input" 
                               type="checkbox" 
                               id="filter-site-addresses" 
                               checked>
                        <label class="form-check-label" for="filter-site-addresses">
                            Адреса участков
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" 
                               type="checkbox" 
                               id="filter-unallocated-addresses">
                        <label class="form-check-label" for="filter-unallocated-addresses">
                            Нераспределенные ({{ unallocated_count }})
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Карта -->
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-map me-2"></i>
                        Карта корпуса и участков
                    </h5>
                    <div>
                        <button type="button" 
                                id="btn-toggle-addresses" 
                                class="btn btn-sm btn-light">
                            <i class="fas fa-map-marker-alt me-1"></i>
                            Показать адреса
                        </button>
                        <button type="button" 
                                id="btn-toggle-labels" 
                                class="btn btn-sm btn-light">
                            <i class="fas fa-tag me-1"></i>
                            Показать названия
                        </button>
                        <button type="button" 
                                id="btn-draw-site" 
                                class="btn btn-sm btn-success">
                            <i class="fas fa-draw-polygon me-1"></i>
                            Нарисовать участок
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="map" style="height: 700px; width: 100%;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Список участков -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>
                        Участки корпуса ({{ sites.count }})
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Название</th>
                                    <th>Тип</th>
                                    <th>Площадь</th>
                                    <th>Адресов</th>
                                    <th>Цвет</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for site in sites %}
                                <tr data-site-id="{{ site.id }}" data-site-type="{{ site.type.code }}">
                                    <td>{{ site.name }}</td>
                                    <td>
                                        <span class="badge bg-secondary">{{ site.type.name }}</span>
                                    </td>
                                    <td>
                                        {% if site.area %}
                                        {{ site.area|floatformat:0 }} м²
                                        {% else %}
                                        —
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ site.site_addresses.count }}</span>
                                    </td>
                                    <td>
                                        <span class="badge" style="background-color: {{ site.color|default:'#4ecdc4' }}">
                                            {{ site.color|default:'#4ecdc4' }}
                                        </span>
                                    </td>
                                    <td>
                                        <button type="button" 
                                                class="btn btn-sm btn-success btn-assign-addresses" 
                                                data-site-id="{{ site.id }}"
                                                title="Привязать адреса">
                                            <i class="fas fa-link"></i>
                                        </button>
                                        <button type="button" 
                                                class="btn btn-sm btn-info btn-view-addresses" 
                                                data-site-id="{{ site.id }}"
                                                title="Просмотреть адреса">
                                            <i class="fas fa-list"></i>
                                        </button>
                                        <button type="button" 
                                                class="btn btn-sm btn-warning btn-edit-site" 
                                                data-site-id="{{ site.id }}">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button type="button" 
                                                class="btn btn-sm btn-danger btn-delete-site" 
                                                data-site-id="{{ site.id }}">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted py-4">
                                        Нет участков. Создайте первый участок на карте.
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<!-- Leaflet Draw CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />

<style>
    #map {
        border-radius: 0 0 0.375rem 0.375rem;
    }
    .leaflet-draw-toolbar {
        margin-top: 10px;
    }
    /* Скрываем флаг SVG в атрибуции Leaflet */
    .leaflet-attribution-flag,
    .leaflet-control-attribution svg,
    .leaflet-control-attribution .leaflet-attribution-flag {
        display: none !important;
        visibility: hidden !important;
        width: 0 !important;
        height: 0 !important;
        opacity: 0 !important;
    }
    .custom-address-marker {
        background: transparent !important;
        border: none !important;
    }
    .site-label {
        background: transparent !important;
        border: none !important;
    }
    .site-label-text {
        pointer-events: none;
        user-select: none;
    }
</style>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- Leaflet Draw JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

<script>
    // Данные корпуса и участков
    const corpusData = {{ corpus_data|safe }};
    const organizationData = {{ organization_data|safe }};
    const sitesData = {{ sites_data|safe }};
    const unallocatedAddressesData = {{ unallocated_addresses_data|safe }};

    // Инициализация карты
    let map;
    let drawnItems = new L.FeatureGroup();
    let currentSitePolygon = null;
    let drawControl = null;
    let corpusMarker = null;
    let sitesLayers = {};
    let organizationPolygon = null;
    let addressesLayers = {};  // Слои адресов по участкам
    let unallocatedAddressesLayer = null;  // Слой нераспределенных адресов
    let siteLabels = {};  // Метки с названиями участков
    let showAddresses = false;
    let showSiteLabels = false;

    // Инициализация карты
    function initMap() {
        map = L.map('map');

        // Добавляем тайлы OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap',
            maxZoom: 19
        }).addTo(map);

        // Добавляем группу для нарисованных элементов
        drawnItems.addTo(map);

        // Отображаем границы организации (только линия, без заливки)
        if (organizationData.polygon) {
            try {
                let orgCoords = organizationData.polygon;
                
                // Если это GeoJSON объект, извлекаем координаты
                if (typeof organizationData.polygon === 'object' && organizationData.polygon.type === 'Polygon') {
                    orgCoords = organizationData.polygon.coordinates[0];
                } else if (Array.isArray(organizationData.polygon)) {
                    orgCoords = organizationData.polygon;
                }

                const orgLatLngs = orgCoords.map(function(coord) {
                    return [coord[1], coord[0]];
                });

                organizationPolygon = L.polygon(orgLatLngs, {
                    color: organizationData.color || '#3388ff',
                    fillColor: organizationData.color || '#3388ff',
                    fillOpacity: 0,  // Прозрачная заливка
                    weight: 3,  // Толстая линия для видимости
                    opacity: 0.8,
                    dashArray: '10, 5'  // Пунктирная линия
                }).addTo(map);

                organizationPolygon.bindPopup(`
                    <div>
                        <h6><strong>${organizationData.name}</strong></h6>
                        <p class="mb-0"><small>Границы организации</small></p>
                    </div>
                `);
            } catch (e) {
                console.error('Ошибка при отображении границ организации:', e);
            }
        }

        // Отображаем маркер адреса корпуса
        if (corpusData.address && corpusData.address.coordinates) {
            corpusMarker = L.marker([
                corpusData.address.coordinates[1],
                corpusData.address.coordinates[0]
            ]).addTo(map);
            
            corpusMarker.bindPopup(`
                <div>
                    <h6><strong>${corpusData.name}</strong></h6>
                    <p class="mb-1">${corpusData.address.street || ''} ${corpusData.address.housenumber || ''}</p>
                </div>
            `);
        }

        // Полигон корпуса не отображаем, так как он вычисляется автоматически из участков
        // Основные элементы для визуализации: границы организации, маркер корпуса и участки
        
        // Подстраиваем карту под границы организации или маркер корпуса
        if (organizationPolygon) {
            // Если есть полигон организации, подстраиваем под него
            // Если есть участки, подстраиваем под них и организацию
            if (sitesData.length > 0) {
                // Собираем границы всех участков
                const siteBounds = [];
                sitesData.forEach(function(site) {
                    if (site.polygon && Array.isArray(site.polygon) && site.polygon.length > 0) {
                        try {
                            const validCoords = site.polygon.filter(function(coord) {
                                return Array.isArray(coord) && coord.length >= 2 && 
                                       typeof coord[0] === 'number' && typeof coord[1] === 'number' &&
                                       !isNaN(coord[0]) && !isNaN(coord[1]);
                            });
                            
                            if (validCoords.length >= 3) {
                                const latLngs = validCoords.map(function(coord) {
                                    return [coord[1], coord[0]];
                                });
                                const tempPolygon = L.polygon(latLngs);
                                siteBounds.push(tempPolygon.getBounds());
                            }
                        } catch (e) {
                            console.error('Ошибка при обработке участка:', e);
                        }
                    }
                });
                
                if (siteBounds.length > 0) {
                    const allBounds = L.latLngBounds(siteBounds);
                    const combinedBounds = L.latLngBounds([
                        allBounds,
                        organizationPolygon.getBounds()
                    ]);
                    map.fitBounds(combinedBounds.pad(0.1));
                } else {
                    map.fitBounds(organizationPolygon.getBounds().pad(0.1));
                }
            } else {
                map.fitBounds(organizationPolygon.getBounds().pad(0.1));
            }
        } else if (corpusMarker) {
            map.setView([corpusMarker.getLatLng().lat, corpusMarker.getLatLng().lng], 15);
        } else {
            map.setView([59.9343, 30.3351], 10);
        }

        // Отображаем участки
        sitesData.forEach(function(site) {
            if (site.polygon && Array.isArray(site.polygon) && site.polygon.length > 0) {
                try {
                    // Проверяем, что координаты валидны
                    const validCoords = site.polygon.filter(function(coord) {
                        return Array.isArray(coord) && coord.length >= 2 && 
                               typeof coord[0] === 'number' && typeof coord[1] === 'number' &&
                               !isNaN(coord[0]) && !isNaN(coord[1]);
                    });
                    
                    if (validCoords.length < 3) {
                        console.warn('Участок', site.name, 'имеет недостаточно валидных координат');
                        return;
                    }
                    
                    const latLngs = validCoords.map(function(coord) {
                        return [coord[1], coord[0]];
                    });

                    const polygon = L.polygon(latLngs, {
                        color: site.color,
                        fillColor: site.color,
                        fillOpacity: 0.3,
                        weight: 2
                    });

                    polygon.bindPopup(`
                        <div>
                            <h6><strong>${site.name}</strong></h6>
                            <p class="mb-1"><small><strong>Тип:</strong> ${site.type_name}</small></p>
                            <p class="mb-1"><small><strong>Адресов:</strong> ${site.address_count || 0}</small></p>
                            ${site.address_count > 0 ? `<p class="mb-1"><small class="text-muted">Привязано к участку</small></p>` : '<p class="mb-1"><small class="text-warning">Нет привязанных адресов</small></p>'}
                            <button class="btn btn-sm btn-warning btn-edit-site-map" data-site-id="${site.id}" style="width: 100%; margin-top: 5px;">
                                <i class="fas fa-edit me-1"></i> Редактировать
                            </button>
                        </div>
                    `);

                    // Сохраняем слой с типом для фильтрации
                    polygon.siteType = site.type_code;
                    polygon.siteId = site.id;
                    
                    sitesLayers[site.id] = polygon;
                    polygon.addTo(map);
                    
                    // Создаем текстовую метку с названием участка в центре полигона
                    const bounds = polygon.getBounds();
                    const center = bounds.getCenter();
                    
                    const labelIcon = L.divIcon({
                        className: 'site-label',
                        html: `<div class="site-label-text" style="background-color: rgba(255, 255, 255, 0.9); padding: 4px 8px; border-radius: 4px; border: 2px solid ${site.color}; color: #333; font-weight: bold; font-size: 14px; white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">${site.name}</div>`,
                        iconSize: [100, 30],
                        iconAnchor: [50, 15]
                    });
                    
                    const labelMarker = L.marker(center, { 
                        icon: labelIcon,
                        interactive: false,
                        keyboard: false
                    });
                    
                    siteLabels[site.id] = labelMarker;
                    
                    // Создаем слой для адресов этого участка
                    if (site.addresses && site.addresses.length > 0) {
                        const addressLayer = L.layerGroup();
                        site.addresses.forEach(function(addr) {
                            if (addr.longitude && addr.latitude) {
                                // Создаем кастомную иконку в цвете участка
                                const customIcon = L.divIcon({
                                    className: 'custom-address-marker',
                                    html: `<div style="background-color: ${site.color}; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
                                    iconSize: [12, 12],
                                    iconAnchor: [6, 6]
                                });
                                
                                const marker = L.marker(
                                    [addr.latitude, addr.longitude],
                                    { icon: customIcon }
                                );
                                
                                marker.bindPopup(`
                                    <div>
                                        <strong>${addr.street || ''} ${addr.housenumber || ''}</strong><br>
                                        <small class="text-muted">Участок: ${site.name}</small>
                                    </div>
                                `);
                                
                                addressLayer.addLayer(marker);
                            }
                        });
                        addressesLayers[site.id] = addressLayer;
                    }
                } catch (e) {
                    console.error('Ошибка при отображении участка:', site.name, e);
                }
            }
        });

        // Создаем слой для нераспределенных адресов
        if (unallocatedAddressesData && unallocatedAddressesData.length > 0) {
            unallocatedAddressesLayer = L.layerGroup();
            unallocatedAddressesData.forEach(function(addr) {
                if (addr.coordinates) {
                    // Красный маркер для нераспределенных адресов
                    const redIcon = L.divIcon({
                        className: 'custom-address-marker',
                        html: `<div style="background-color: #dc3545; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
                        iconSize: [12, 12],
                        iconAnchor: [6, 6]
                    });
                    
                    const marker = L.marker([addr.coordinates[1], addr.coordinates[0]], { icon: redIcon });
                    marker.bindPopup(`
                        <div>
                            <strong>${addr.street || ''} ${addr.housenumber || ''}</strong><br>
                            <small class="text-danger">Нераспределенный адрес</small><br>
                            <small class="text-muted">${addr.city || ''}</small>
                        </div>
                    `);
                    unallocatedAddressesLayer.addLayer(marker);
                }
            });
        }

        // Инициализируем Leaflet Draw
        drawControl = new L.Control.Draw({
            draw: {
                polygon: {
                    allowIntersection: false,
                    showArea: true
                },
                polyline: false,
                rectangle: false,
                circle: false,
                marker: false,
                circlemarker: false
            },
            edit: {
                featureGroup: drawnItems,
                remove: true
            }
        });
        map.addControl(drawControl);

        // Обработчики событий рисования
        map.on(L.Draw.Event.CREATED, function(e) {
            const layer = e.layer;
            
            if (currentSitePolygon) {
                drawnItems.removeLayer(currentSitePolygon);
            }
            
            drawnItems.addLayer(layer);
            currentSitePolygon = layer;
            
            // Активируем форму
            const siteForm = document.getElementById('site-form');
            if (siteForm) {
                siteForm.style.display = 'block';
            }
        });

        // Редактирование участка из popup на карте (делегирование событий)
        map.on('popupopen', function(e) {
            const popup = e.popup;
            const popupElement = popup.getElement();
            if (popupElement) {
                const editBtn = popupElement.querySelector('.btn-edit-site-map');
                if (editBtn) {
                    // Удаляем старый обработчик, если есть
                    const newEditBtn = editBtn.cloneNode(true);
                    editBtn.parentNode.replaceChild(newEditBtn, editBtn);
                    
                    newEditBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        const siteId = this.getAttribute('data-site-id');
                        if (siteId) {
                            map.closePopup();
                            editSite(siteId);
                        }
                    });
                }
            }
        });
    }

    // Кнопка рисования участка (после загрузки DOM)
    document.addEventListener('DOMContentLoaded', function() {
        const btnDrawSite = document.getElementById('btn-draw-site');
        if (btnDrawSite) {
            btnDrawSite.addEventListener('click', function() {
                if (map) {
                    const drawPolygon = new L.Draw.Polygon(map, {
                        allowIntersection: false,
                        showArea: true
                    });
                    drawPolygon.enable();
                }
            });
        }

        // Сохранение участка
        const siteForm = document.getElementById('site-form');
        if (siteForm) {
            siteForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const btn = document.getElementById('btn-save-site');
        const statusDiv = document.getElementById('save-status');
        const siteId = document.getElementById('site-id').value;
        
        if (!currentSitePolygon && !siteId) {
            statusDiv.innerHTML = '<div class="alert alert-warning">Сначала нарисуйте полигон участка на карте</div>';
            return;
        }

        const name = document.getElementById('site-name').value;
        const typeCode = document.getElementById('site-type').value;
        const color = document.getElementById('site-color').value;
        const description = document.getElementById('site-description').value;

        if (!name || !typeCode) {
            statusDiv.innerHTML = '<div class="alert alert-warning">Заполните название и тип участка</div>';
            return;
        }

        let polygon = null;
        if (currentSitePolygon) {
            const latlngs = currentSitePolygon.getLatLngs()[0];
            polygon = latlngs.map(function(latlng) {
                return [latlng.lng, latlng.lat];
            });
            if (polygon[0][0] !== polygon[polygon.length - 1][0] || 
                polygon[0][1] !== polygon[polygon.length - 1][1]) {
                polygon.push(polygon[0]);
            }
        }

        btn.disabled = true;
        statusDiv.innerHTML = '<div class="alert alert-info">Сохранение...</div>';

        fetch('{% url "zones:site_create_or_update" corpus.pk %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                id: siteId || null,
                name: name,
                type_code: typeCode,
                polygon: polygon,
                color: color,
                description: description
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                statusDiv.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
                // Автоматически привязываем адреса после сохранения участка
                if (data.site_id && currentSitePolygon) {
                    fetch(`/zones/site/${data.site_id}/assign-addresses/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        }
                    })
                    .then(response => response.json())
                    .then(assignData => {
                        if (assignData.success) {
                            statusDiv.innerHTML += `<div class="alert alert-info mt-2">${assignData.message}</div>`;
                        }
                        setTimeout(function() {
                            window.location.reload();
                        }, 2000);
                    })
                    .catch(() => {
                        setTimeout(function() {
                            window.location.reload();
                        }, 1000);
                    });
                } else {
                    setTimeout(function() {
                        window.location.reload();
                    }, 1000);
                }
            } else {
                statusDiv.innerHTML = `<div class="alert alert-danger">Ошибка: ${data.error}</div>`;
                btn.disabled = false;
            }
        })
        .catch(error => {
            statusDiv.innerHTML = `<div class="alert alert-danger">Ошибка: ${error.message}</div>`;
            btn.disabled = false;
        });
            });
        }
    });

    // Функция для редактирования участка
    function editSite(siteId) {
        fetch(`/zones/site/${siteId}/`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('site-id').value = data.id;
                document.getElementById('site-name').value = data.name;
                document.getElementById('site-type').value = data.type_code;
                document.getElementById('site-color').value = data.color;
                document.getElementById('site-description').value = data.description || '';
                document.getElementById('btn-cancel-edit').style.display = 'block';
                document.getElementById('btn-save-site').innerHTML = '<i class="fas fa-save me-1"></i> Обновить участок';
                
                // Показываем полигон на карте для редактирования
                if (data.polygon) {
                    const latLngs = data.polygon.map(function(coord) {
                        return [coord[1], coord[0]];
                    });
                    
                    if (currentSitePolygon) {
                        drawnItems.removeLayer(currentSitePolygon);
                    }
                    
                    currentSitePolygon = L.polygon(latLngs, {
                        color: data.color,
                        fillColor: data.color,
                        fillOpacity: 0.3,
                        weight: 2
                    }).addTo(drawnItems);
                    
                    map.fitBounds(currentSitePolygon.getBounds().pad(0.1));
                }
            })
            .catch(error => {
                console.error('Ошибка при загрузке данных участка:', error);
                alert('Ошибка при загрузке данных участка');
            });
    }

    // Редактирование участка из таблицы (после загрузки DOM)
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.btn-edit-site').forEach(function(btn) {
            btn.addEventListener('click', function() {
                const siteId = this.getAttribute('data-site-id');
                if (siteId) {
                    editSite(siteId);
                }
            });
        });
    });


    // Удаление участка (после загрузки DOM)
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.btn-delete-site').forEach(function(btn) {
            btn.addEventListener('click', function() {
                if (!confirm('Вы уверены, что хотите удалить этот участок?')) {
                    return;
                }
                
                const siteId = this.getAttribute('data-site-id');
                if (siteId) {
                    fetch(`/zones/site/${siteId}/delete/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            window.location.reload();
                        } else {
                            alert('Ошибка: ' + data.error);
                        }
                    })
                    .catch(error => {
                        alert('Ошибка: ' + error.message);
                    });
                }
            });
        });
    });

    // Фильтрация участков по типам (после загрузки DOM)
    document.addEventListener('DOMContentLoaded', function() {
        const filterAll = document.getElementById('filter-all');
        if (filterAll) {
            filterAll.addEventListener('change', function() {
                const checked = this.checked;
                document.querySelectorAll('.site-type-filter').forEach(function(filter) {
                    filter.checked = checked;
                    toggleSiteLayer(filter.getAttribute('data-type'), checked);
                });
            });
        }

        document.querySelectorAll('.site-type-filter').forEach(function(filter) {
            filter.addEventListener('change', function() {
                toggleSiteLayer(this.getAttribute('data-type'), this.checked);
                
                // Обновляем состояние "Все"
                const filterAll = document.getElementById('filter-all');
                if (filterAll) {
                    const allChecked = Array.from(document.querySelectorAll('.site-type-filter')).every(f => f.checked);
                    filterAll.checked = allChecked;
                }
            });
        });
    });

    function toggleSiteLayer(typeCode, show) {
        Object.values(sitesLayers).forEach(function(layer) {
            if (layer.siteType === typeCode) {
                if (show) {
                    layer.addTo(map);
                    // Показываем адреса этого участка, если они включены
                    const filterSiteAddresses = document.getElementById('filter-site-addresses');
                    if (filterSiteAddresses && filterSiteAddresses.checked && addressesLayers[layer.siteId]) {
                        addressesLayers[layer.siteId].addTo(map);
                    }
                    // Показываем метку, если она включена
                    if (showSiteLabels && siteLabels[layer.siteId]) {
                        siteLabels[layer.siteId].addTo(map);
                    }
                } else {
                    map.removeLayer(layer);
                    // Скрываем адреса этого участка
                    if (addressesLayers[layer.siteId]) {
                        map.removeLayer(addressesLayers[layer.siteId]);
                    }
                    // Скрываем метку
                    if (siteLabels[layer.siteId]) {
                        map.removeLayer(siteLabels[layer.siteId]);
                    }
                }
            }
        });
    }

    // Отмена редактирования (после загрузки DOM)
    document.addEventListener('DOMContentLoaded', function() {
        const btnCancelEdit = document.getElementById('btn-cancel-edit');
        if (btnCancelEdit) {
            btnCancelEdit.addEventListener('click', function() {
                const siteForm = document.getElementById('site-form');
                const siteId = document.getElementById('site-id');
                const btnSaveSite = document.getElementById('btn-save-site');
                
                if (siteForm) siteForm.reset();
                if (siteId) siteId.value = '';
                this.style.display = 'none';
                if (btnSaveSite) btnSaveSite.innerHTML = '<i class="fas fa-save me-1"></i> Сохранить участок';
                
                if (currentSitePolygon) {
                    drawnItems.removeLayer(currentSitePolygon);
                    currentSitePolygon = null;
                }
            });
        }
    });

    // Привязка адресов к участку (после загрузки DOM)
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.btn-assign-addresses').forEach(function(btn) {
            btn.addEventListener('click', function() {
                const siteId = this.getAttribute('data-site-id');
                
                if (!siteId) return;
                
                if (!confirm('Привязать все адреса внутри полигона участка?')) {
                    return;
                }
                
                fetch(`/zones/site/${siteId}/assign-addresses/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        window.location.reload();
                    } else {
                        alert('Ошибка: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('Ошибка: ' + error.message);
                });
            });
        });

        // Просмотр адресов участка
        document.querySelectorAll('.btn-view-addresses').forEach(function(btn) {
            btn.addEventListener('click', function() {
                const siteId = this.getAttribute('data-site-id');
                
                if (!siteId) return;
                
                fetch(`/zones/site/${siteId}/addresses/`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.addresses.length === 0) {
                            alert('Нет привязанных адресов. Используйте кнопку "Привязать адреса" для автоматической привязки.');
                            return;
                        }
                        
                        let message = `Адреса участка (${data.count}):\n\n`;
                        data.addresses.forEach(function(addr, index) {
                            message += `${index + 1}. ${addr.street || ''} ${addr.housenumber || ''}\n`;
                        });
                        alert(message);
                    })
                    .catch(error => {
                        alert('Ошибка: ' + error.message);
                    });
            });
        });
    });

    // Переключение отображения адресов и фильтры (после загрузки DOM)
    document.addEventListener('DOMContentLoaded', function() {
        const btnToggleAddresses = document.getElementById('btn-toggle-addresses');
        if (btnToggleAddresses) {
            btnToggleAddresses.addEventListener('click', function() {
                const filterSiteAddresses = document.getElementById('filter-site-addresses');
                const filterUnallocated = document.getElementById('filter-unallocated-addresses');
                
                if (filterSiteAddresses && filterUnallocated) {
                    const siteAddressesChecked = filterSiteAddresses.checked;
                    const unallocatedChecked = filterUnallocated.checked;
                    
                    // Переключаем оба фильтра
                    filterSiteAddresses.checked = !siteAddressesChecked;
                    filterUnallocated.checked = !unallocatedChecked;
                    
                    // Вызываем обработчики фильтров
                    filterSiteAddresses.dispatchEvent(new Event('change'));
                    filterUnallocated.dispatchEvent(new Event('change'));
                }
            });
        }

        // Переключение отображения названий участков
        const btnToggleLabels = document.getElementById('btn-toggle-labels');
        if (btnToggleLabels) {
            btnToggleLabels.addEventListener('click', function() {
                showSiteLabels = !showSiteLabels;
                
                Object.values(siteLabels).forEach(function(label) {
                    if (label && map) {
                        if (showSiteLabels) {
                            label.addTo(map);
                        } else {
                            map.removeLayer(label);
                        }
                    }
                });
                
                if (showSiteLabels) {
                    this.innerHTML = '<i class="fas fa-eye-slash me-1"></i> Скрыть названия';
                } else {
                    this.innerHTML = '<i class="fas fa-tag me-1"></i> Показать названия';
                }
            });
        }

        // Фильтр адресов участков
        const filterSiteAddresses = document.getElementById('filter-site-addresses');
        if (filterSiteAddresses) {
            filterSiteAddresses.addEventListener('change', function() {
                const show = this.checked;
                if (map) {
                    Object.values(addressesLayers).forEach(function(layer) {
                        if (layer) {
                            if (show) {
                                layer.addTo(map);
                            } else {
                                map.removeLayer(layer);
                            }
                        }
                    });
                }
            });
        }

        // Фильтр нераспределенных адресов
        const filterUnallocated = document.getElementById('filter-unallocated-addresses');
        if (filterUnallocated) {
            filterUnallocated.addEventListener('change', function() {
                if (unallocatedAddressesLayer && map) {
                    if (this.checked) {
                        unallocatedAddressesLayer.addTo(map);
                    } else {
                        map.removeLayer(unallocatedAddressesLayer);
                    }
                }
            });
        }
    });

    // Инициализация при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        initMap();
        
        // Инициализация фильтров адресов - адреса участков показываем по умолчанию
        const filterSiteAddresses = document.getElementById('filter-site-addresses');
        if (filterSiteAddresses && filterSiteAddresses.checked) {
            Object.values(addressesLayers).forEach(function(layer) {
                if (layer && map) {
                    layer.addTo(map);
                }
            });
        }
        
        // Названия участков по умолчанию скрыты, но можно включить через кнопку
        // showSiteLabels остается false по умолчанию
        
        // Убираем флаг SVG из атрибуции после загрузки карты
        function removeFlagFromAttribution() {
            const flags = document.querySelectorAll('.leaflet-attribution-flag, .leaflet-control-attribution svg');
            flags.forEach(function(flag) {
                flag.style.display = 'none';
                flag.remove();
            });
        }
        removeFlagFromAttribution();
        setTimeout(removeFlagFromAttribution, 100);
        setTimeout(removeFlagFromAttribution, 500);
        setTimeout(removeFlagFromAttribution, 1000);
        
        // Отслеживаем появление новых элементов
        const observer = new MutationObserver(function(mutations) {
            removeFlagFromAttribution();
        });
        
        setTimeout(function() {
            const attribution = document.querySelector('.leaflet-control-attribution');
            if (attribution) {
                observer.observe(attribution, { childList: true, subtree: true });
            }
        }, 500);
    });
</script>
{% endblock %}
