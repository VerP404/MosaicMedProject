{% extends 'home/base.html' %}
{% load static %}

{% block title %}{{ page_title }} - МозаикаМед{% endblock %}

{% block content %}
<main class="content">
    <div class="container-fluid p-0">
        <!-- Заголовок страницы -->
        <div class="row mb-2 mb-xl-3">
            <div class="col-auto d-none d-sm-block">
                <h3><i class="fas fa-heart-pulse"></i> {{ page_title }}</h3>
            </div>
        </div>

        <!-- Статистика -->
        <div class="row" id="statistics-cards">
            <div class="col-xl-3 col-md-6">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col mt-0">
                                <h5 class="card-title">Всего льготников</h5>
                            </div>
                            <div class="col-auto">
                                <div class="stat text-primary">
                                    <i class="fas fa-users fa-2x"></i>
                                </div>
                            </div>
                        </div>
                        <h1 class="mt-1 mb-3" id="stat-total-patients">-</h1>
                        <div class="mb-0">
                            <span class="text-muted">Активных пациентов</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-3 col-md-6">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col mt-0">
                                <h5 class="card-title">Категорий льгот</h5>
                            </div>
                            <div class="col-auto">
                                <div class="stat text-success">
                                    <i class="fas fa-list fa-2x"></i>
                                </div>
                            </div>
                        </div>
                        <h1 class="mt-1 mb-3" id="stat-total-categories">-</h1>
                        <div class="mb-0">
                            <span class="text-muted">Активных категорий</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-3 col-md-6">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col mt-0">
                                <h5 class="card-title">Срочные</h5>
                            </div>
                            <div class="col-auto">
                                <div class="stat text-warning">
                                    <i class="fas fa-exclamation-triangle fa-2x"></i>
                                </div>
                            </div>
                        </div>
                        <h1 class="mt-1 mb-3" id="stat-urgent-supplies">-</h1>
                        <div class="mb-0">
                            <span class="text-muted">Заканчиваются скоро</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-3 col-md-6">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col mt-0">
                                <h5 class="card-title">Истекшие</h5>
                            </div>
                            <div class="col-auto">
                                <div class="stat text-danger">
                                    <i class="fas fa-times-circle fa-2x"></i>
                                </div>
                            </div>
                        </div>
                        <h1 class="mt-1 mb-3" id="stat-expired-supplies">-</h1>
                        <div class="mb-0">
                            <span class="text-muted">Истекших препаратов</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Фильтры и поиск -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Фильтры и поиск</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <label>Поиск</label>
                                <input type="text" class="form-control" id="search-input" placeholder="Поиск по ФИО, СНИЛС, ЕНП...">
                            </div>
                            <div class="col-md-3">
                                <label>Категория льготы</label>
                                <select class="form-control" id="category-filter">
                                    <option value="">Все категории</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label>Возраст</label>
                                <select class="form-control" id="age-filter">
                                    <option value="">Все</option>
                                    <option value="true">Дети</option>
                                    <option value="false">Взрослые</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label>Статус</label>
                                <select class="form-control" id="status-filter">
                                    <option value="active">Активные</option>
                                    <option value="all">Все</option>
                                </select>
                            </div>
                            <div class="col-md-1 d-flex align-items-end">
                                <button class="btn btn-primary w-100" onclick="loadBeneficiaries()">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Таблица льготников -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Список льготников</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="beneficiaries-table">
                                <thead>
                                    <tr>
                                        <th>ФИО</th>
                                        <th>Дата рождения</th>
                                        <th>Возраст</th>
                                        <th>СНИЛС</th>
                                        <th>ЕНП</th>
                                        <th>Категория льготы</th>
                                        <th>Диагноз</th>
                                        <th>Препараты</th>
                                        <th>Действия</th>
                                    </tr>
                                </thead>
                                <tbody id="beneficiaries-tbody">
                                    <tr>
                                        <td colspan="9" class="text-center">
                                            <div class="spinner-border" role="status">
                                                <span class="visually-hidden">Загрузка...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Пагинация -->
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <p id="pagination-info">Показано 0 из 0 записей</p>
                            </div>
                            <div class="col-md-6">
                                <nav>
                                    <ul class="pagination justify-content-end" id="pagination"></ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
let currentPage = 1;
const pageSize = 25;

// Загрузка статистики
function loadStatistics() {
    fetch("{% url 'beneficiaries:statistics_api' %}")
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const stats = data.statistics;
                document.getElementById('stat-total-patients').textContent = stats.total_patients;
                document.getElementById('stat-total-categories').textContent = stats.total_categories;
                document.getElementById('stat-urgent-supplies').textContent = stats.urgent_supplies;
                document.getElementById('stat-expired-supplies').textContent = stats.expired_supplies;
            }
        })
        .catch(error => console.error('Ошибка при загрузке статистики:', error));
}

// Загрузка категорий для фильтра
function loadCategories() {
    fetch("{% url 'beneficiaries:categories_api' %}")
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const select = document.getElementById('category-filter');
                data.categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = `${category.name} (${category.patients_count})`;
                    select.appendChild(option);
                });
            }
        })
        .catch(error => console.error('Ошибка при загрузке категорий:', error));
}

// Загрузка списка льготников
function loadBeneficiaries(page = 1) {
    const search = document.getElementById('search-input').value;
    const category = document.getElementById('category-filter').value;
    const isChildren = document.getElementById('age-filter').value;
    const status = document.getElementById('status-filter').value;
    
    const params = new URLSearchParams({
        page: page,
        page_size: pageSize,
        search: search,
        category: category,
        is_children: isChildren,
        status: status
    });
    
    fetch(`{% url 'beneficiaries:list_api' %}?${params}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderTable(data.patients);
                renderPagination(data.pagination);
                currentPage = page;
            }
        })
        .catch(error => {
            console.error('Ошибка при загрузке данных:', error);
            document.getElementById('beneficiaries-tbody').innerHTML = 
                '<tr><td colspan="9" class="text-center text-danger">Ошибка при загрузке данных</td></tr>';
        });
}

// Отрисовка таблицы
function renderTable(patients) {
    const tbody = document.getElementById('beneficiaries-tbody');
    
    if (patients.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center">Нет данных</td></tr>';
        return;
    }
    
    tbody.innerHTML = patients.map(patient => `
        <tr>
            <td><strong>${patient.full_name}</strong></td>
            <td>${patient.birth_date}</td>
            <td>${patient.age}</td>
            <td>${patient.snils}</td>
            <td>${patient.enp}</td>
            <td><span class="badge bg-info">${patient.benefit_category}</span></td>
            <td>
                ${patient.diagnosis_code !== '-' ? 
                    `<span class="badge bg-secondary">${patient.diagnosis_code}</span> ${patient.diagnosis_name}` : 
                    '-'
                }
            </td>
            <td>
                <span class="badge bg-primary">${patient.total_drugs} всего</span>
                ${patient.urgent_drugs > 0 ? `<span class="badge bg-warning">${patient.urgent_drugs} срочно</span>` : ''}
                ${patient.expired_drugs > 0 ? `<span class="badge bg-danger">${patient.expired_drugs} истекло</span>` : ''}
            </td>
            <td>
                <a href="{% url 'beneficiaries:patient_detail' 0 %}".replace('0', patient.id) class="btn btn-sm btn-primary">
                    <i class="fas fa-eye"></i> Просмотр
                </a>
            </td>
        </tr>
    `).join('');
}

// Отрисовка пагинации
function renderPagination(pagination) {
    const info = document.getElementById('pagination-info');
    info.textContent = `Показано ${pagination.total_count > 0 ? ((pagination.current_page - 1) * pageSize + 1) : 0}-${Math.min(pagination.current_page * pageSize, pagination.total_count)} из ${pagination.total_count} записей`;
    
    const paginationEl = document.getElementById('pagination');
    paginationEl.innerHTML = '';
    
    // Кнопка "Предыдущая"
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${!pagination.has_previous ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="#" onclick="loadBeneficiaries(${pagination.current_page - 1}); return false;">Предыдущая</a>`;
    paginationEl.appendChild(prevLi);
    
    // Номера страниц
    for (let i = 1; i <= pagination.total_pages; i++) {
        if (i === 1 || i === pagination.total_pages || (i >= pagination.current_page - 2 && i <= pagination.current_page + 2)) {
            const li = document.createElement('li');
            li.className = `page-item ${i === pagination.current_page ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#" onclick="loadBeneficiaries(${i}); return false;">${i}</a>`;
            paginationEl.appendChild(li);
        } else if (i === pagination.current_page - 3 || i === pagination.current_page + 3) {
            const li = document.createElement('li');
            li.className = 'page-item disabled';
            li.innerHTML = '<span class="page-link">...</span>';
            paginationEl.appendChild(li);
        }
    }
    
    // Кнопка "Следующая"
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${!pagination.has_next ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="#" onclick="loadBeneficiaries(${pagination.current_page + 1}); return false;">Следующая</a>`;
    paginationEl.appendChild(nextLi);
}

// Поиск при нажатии Enter
document.getElementById('search-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        loadBeneficiaries(1);
    }
});

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    loadStatistics();
    loadCategories();
    loadBeneficiaries(1);
});
</script>

<style>
.stat {
    display: inline-block;
}

.badge {
    margin-right: 5px;
}

.table-responsive {
    min-height: 400px;
}

#beneficiaries-table tbody tr {
    cursor: pointer;
}

#beneficiaries-table tbody tr:hover {
    background-color: #f8f9fa;
}
</style>
{% endblock %}

