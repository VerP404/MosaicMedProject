# Инструкция по синхронизации структуры показателей между серверами

## Обзор

Структура показателей синхронизируется между серверами через JSON файл с использованием `external_id` для идентификации групп.

## Процесс синхронизации

### На основном сервере (базовый)

1. **Экспорт структуры с фильтрами:**
```bash
python manage.py export_indicators_structure --include-filters --year 2025
```

2. **Сохранить файл в Git:**
   - Файл будет сохранен в `apps/plan/fixtures/indicators_structure.json`
   - Закоммитить и запушить изменения

### На клиентских серверах

#### Вариант 1: Первый импорт (новый сервер без данных)

1. **Получить файл из Git:**
```bash
git pull
```

2. **Импорт структуры:**
```bash
python manage.py import_indicators_structure
```

#### Вариант 2: Сервер с существующими данными

**⚠️ ВАЖНО: Сначала проверьте, что будет изменено!**

1. **Проверка (dry-run):**
```bash
python manage.py import_indicators_structure --update-existing --dry-run
```

2. **Просмотр результатов:**
   - Команда покажет, какие группы будут созданы/обновлены
   - Проверьте, что это ожидаемые изменения

3. **Импорт с обновлением:**
```bash
python manage.py import_indicators_structure --update-existing
```

## Что происходит с данными

### Группы (GroupIndicators)

#### Группы с `external_id` из файла:
- **Если группа уже существует** (найдена по `external_id`):
  - Группа **обновляется** (имя, уровень, is_distributable, родитель)
  - **Все связанные планы СОХРАНЯЮТСЯ** (AnnualPlan, MonthlyPlan, BuildingPlan, DepartmentPlan)
  - Планы НЕ удаляются и остаются связанными с группой

- **Если группы нет** (новый `external_id`):
  - Группа **создается** заново
  - Планы создаются автоматически при сохранении (если `is_distributable=True`)

#### Группы с другим `external_id` или без `external_id`:
- **НЕ удаляются** автоматически (только с флагом `--delete-missing`)
- Остаются в базе, но не синхронизируются
- **⚠️ МОГУТ БЫТЬ ДУБЛИ**: Если у вас уже есть группа "Амбулаторная помощь" с другим `external_id`, 
  а в файле есть группа с таким же именем, но другим `external_id`, то:
  - Существующая группа останется в базе
  - Будет создана новая группа с импортируемым `external_id`
  - **Получится дубль** - две группы с одинаковым именем, но разными `external_id`

### Фильтры (FilterCondition)

#### Фильтры для импортируемого года (2025 в примере):
- **Старые фильтры УДАЛЯЮТСЯ** для этого года
  - Удаляются только фильтры, которые соответствуют импортируемым (group, field_name, filter_type, year)
  - Например, если в файле есть фильтр `goal='3'` для 2025 года, то:
    - Все существующие фильтры с `goal='3'` для 2025 года будут удалены
    - Будет создан новый фильтр из файла
- **Фильтры для других годов (2024, 2026 и т.д.) СОХРАНЯЮТСЯ** и не затрагиваются

#### Пример:
- До импорта: фильтры для 2024, 2025, 2026 годов
- После импорта: фильтры для 2024 и 2026 остались, фильтры для 2025 заменены на новые из файла

### Планы (AnnualPlan, MonthlyPlan, BuildingPlan, DepartmentPlan)

- **Все планы СОХРАНЯЮТСЯ** при обновлении группы
  - Планы связаны с группой через ForeignKey с `on_delete=models.CASCADE`
  - Но при обновлении группы (изменение имени, уровня и т.д.) планы НЕ удаляются
  - Планы остаются связанными с той же группой

- **При создании новой группы:**
  - Планы создаются автоматически при сохранении группы (если `is_distributable=True`)
  - Создаются AnnualPlan, MonthlyPlan, и связанные планы для корпусов/отделений

### ⚠️ Важно: Дубли групп

Если у вас уже есть группа с тем же именем, но с другим `external_id` (или без него):

1. **Существующая группа останется** в базе со всеми её планами
2. **Будет создана новая группа** с импортируемым `external_id`
3. **Получится дубль** - две группы с одинаковым именем

**Решение дублей:**
- Перед импортом проверьте группы в админке Django
- Если есть дубли - либо удалите старую группу вручную, либо присвойте ей правильный `external_id`
- Или используйте `--delete-missing` (⚠️ это удалит ВСЕ группы, которых нет в файле, включая их планы!)

## Рекомендации

### Перед первым импортом

1. **Сделайте резервную копию базы данных:**
```bash
python manage.py dumpdata plan > backup_before_sync.json
```

2. **Проверьте существующие группы:**
```python
# В Django shell
from apps.plan.models import GroupIndicators
groups_without_external_id = GroupIndicators.objects.filter(external_id__isnull=True)
print(f"Групп без external_id: {groups_without_external_id.count()}")
```

### Если нужно удалить локальные группы

⚠️ **ОПАСНО! Удалит все связанные планы!**

```bash
python manage.py import_indicators_structure --update-existing --delete-missing
```

### Если есть конфликты

Если на клиентском сервере есть группы с теми же именами, но без `external_id`:

1. **Проверьте вручную** в админке Django
2. **Присвойте `external_id`** вручную, если это та же группа
3. **Или удалите** локальную группу перед импортом

## Примеры команд

### Полный цикл синхронизации

**На основном сервере:**
```bash
# Экспорт с фильтрами для 2025 года
python manage.py export_indicators_structure --include-filters --year 2025

# Закоммитить и запушить в Git
git add apps/plan/fixtures/indicators_structure.json
git commit -m "Обновление структуры показателей"
git push
```

**На клиентском сервере:**
```bash
# Получить обновления
git pull

# Проверка перед импортом
python manage.py import_indicators_structure --update-existing --dry-run

# Импорт
python manage.py import_indicators_structure --update-existing
```

## Часто задаваемые вопросы

### Q: Что будет с планами, если я обновлю группу?

**A:** Планы останутся. Они связаны с группой через ForeignKey, поэтому при обновлении группы (имя, уровень и т.д.) планы не затрагиваются.

### Q: Нужно ли удалять существующие группы перед импортом?

**A:** Нет, не обязательно. Команда импорта обновит группы по `external_id`. Удалять нужно только если вы хотите удалить группы, которых нет в импортируемом файле (используйте `--delete-missing`, но это удалит все связанные планы!).

### Q: Что если на клиентском сервере уже есть данные?

**A:** 
- Если у группы есть `external_id` из файла - она обновится, планы сохранятся
- Если у группы нет `external_id` или другой `external_id` - она останется как есть, но не будет синхронизироваться

### Q: Как синхронизировать фильтры для нового года?

**A:** При экспорте укажите нужный год:
```bash
python manage.py export_indicators_structure --include-filters --year 2026
```

И при импорте фильтры для этого года обновятся, а для других годов останутся прежними.

