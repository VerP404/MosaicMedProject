# Модуль справочников (references)

## МКБ-10

### Загрузка данных

Для загрузки данных МКБ-10 используется команда:
```bash
python manage.py load_mkb10 apps/references/files/mkb10.xml
```

Команда:
1. Сохраняет существующие записи и их ID
2. Обновляет данные из XML файла:
   - Обновляет существующие записи (название, уровень, активность)
   - Создает новые записи
   - Деактивирует записи, которых нет в новом файле
3. Автоматически определяет уровни и связи между кодами
4. Устанавливает флаг активности на основе поля `FlagOms`
5. Определяет конечные диагнозы (без подкодов)

При обновлении данных:
- ID записей сохраняются, что позволяет безопасно использовать внешние ключи
- Удаленные из справочника коды не удаляются из базы, а деактивируются
- Все связи с другими таблицами сохраняются
- Автоматически пересчитываются флаги конечных диагнозов

### API

#### 1. Получение списка кодов
```
GET /api/mkb10/
```

Параметры запроса:
- `search` - поиск по коду или названию
- `level` - фильтр по уровню (1 - категории, 2 - подкатегории)
- `is_active` - фильтр по активности (true/false)
- `is_final` - фильтр по конечным диагнозам (true/false)

Примеры:
```
/api/mkb10/?search=холера
/api/mkb10/?level=1
/api/mkb10/?is_active=true
/api/mkb10/?is_final=true
```

#### 2. Получение детальной информации о коде
```
GET /api/mkb10/{code}/
```

Пример:
```
/api/mkb10/A00.0/
```

#### 3. Получение дочерних кодов
```
GET /api/mkb10/{code}/children/
```

Пример:
```
/api/mkb10/A00/children/
```

### Обновление данных

1. Замените файл `mkb10.xml` в директории `apps/references/files/`
2. Запустите команду загрузки данных:
```bash
python manage.py load_mkb10 apps/references/files/mkb10.xml
```

### Структура данных

- `id` - уникальный идентификатор (сохраняется при обновлении)
- `code` - код МКБ-10 (например, A00.0)
- `name` - название диагноза
- `level` - уровень в иерархии (1 - категория, 2 - подкатегория)
- `parent` - ссылка на родительский код
- `is_active` - флаг активности
- `is_final` - флаг конечного диагноза (без подкодов)
- `created_at` - дата создания записи
- `updated_at` - дата последнего обновления 