# Модуль справочников (references)

## МКБ-10

### Загрузка данных

Для загрузки данных МКБ-10 используется команда:
```bash
python manage.py load_mkb10 apps/references/files/mkb10.xml
```

Команда:
1. Сохраняет существующие записи и их ID
2. Обновляет данные из XML файла:
   - Обновляет существующие записи (название, уровень, активность)
   - Создает новые записи
   - Деактивирует записи, которых нет в новом файле
3. Автоматически определяет уровни и связи между кодами
4. Устанавливает флаг активности на основе поля `FlagOms`
5. Определяет конечные диагнозы (без подкодов)

При обновлении данных:
- ID записей сохраняются, что позволяет безопасно использовать внешние ключи
- Удаленные из справочника коды не удаляются из базы, а деактивируются
- Все связи с другими таблицами сохраняются
- Автоматически пересчитываются флаги конечных диагнозов

### API

#### 1. Получение списка кодов
```
GET /api/mkb10/
```

Параметры запроса:
- `search` - поиск по коду или названию
- `level` - фильтр по уровню (1 - категории, 2 - подкатегории)
- `is_active` - фильтр по активности (true/false)
- `is_final` - фильтр по конечным диагнозам (true/false)

Примеры:
```
/api/mkb10/?search=холера
/api/mkb10/?level=1
/api/mkb10/?is_active=true
/api/mkb10/?is_final=true
```

#### 2. Получение детальной информации о коде
```
GET /api/mkb10/{code}/
```

Пример:
```
/api/mkb10/A00.0/
```

#### 3. Получение дочерних кодов
```
GET /api/mkb10/{code}/children/
```

Пример:
```
/api/mkb10/A00/children/
```

## Страховые медицинские организации (СМО)

### Загрузка данных

Для загрузки данных СМО используется команда:
```bash
python manage.py load_insurance_companies apps/references/files/f002.xml
```

Команда:
1. Сохраняет существующие записи и их ID
2. Обновляет данные из XML файла:
   - Обновляет существующие записи
   - Создает новые записи
   - Деактивирует записи, которых нет в новом файле
3. Сохраняет все связи с другими таблицами
4. Поддерживает флаг СМО по умолчанию (только одна СМО может быть по умолчанию)

При обновлении данных:
- ID записей сохраняются
- Удаленные из справочника СМО не удаляются из базы, а деактивируются
- Все связи с другими таблицами сохраняются
- Флаг СМО по умолчанию автоматически сбрасывается у других СМО

### API

#### 1. Получение списка СМО
```
GET /api/insurance-companies/
```

Параметры запроса:
- `search` - поиск по коду, названию, ИНН или ОГРН
- `is_active` - фильтр по активности (true/false)
- `is_default` - фильтр по СМО по умолчанию (true/false)

Примеры:
```
/api/insurance-companies/?search=СОГАЗ
/api/insurance-companies/?is_active=true
/api/insurance-companies/?is_default=true
```

#### 2. Получение детальной информации о СМО
```
GET /api/insurance-companies/{code}/
```

Пример:
```
/api/insurance-companies/01004/
```

### Структура данных

- `id` - уникальный идентификатор (сохраняется при обновлении)
- `smocod` - код СМО
- `nam_smok` - краткое наименование
- `nam_smop` - полное наименование
- `inn` - ИНН
- `ogrn` - ОГРН
- `kpp` - КПП
- `jur_address` - юридический адрес
- `pst_address` - почтовый адрес
- `head_lastname` - фамилия руководителя
- `head_firstname` - имя руководителя
- `head_middlename` - отчество руководителя
- `phone` - телефон
- `fax` - факс
- `hot_line` - горячая линия
- `email` - email
- `website` - сайт
- `license_number` - номер лицензии
- `license_start_date` - дата начала лицензии
- `license_end_date` - дата окончания лицензии
- `is_active` - флаг активности
- `is_default` - флаг СМО по умолчанию
- `year_work` - год работы
- `last_update` - дата последнего обновления
- `insured_count` - количество застрахованных
- `created_at` - дата создания записи
- `updated_at` - дата последнего обновления 